<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="./../assets/css/app.css">
    <link rel="stylesheet" href="./../assets/css/processo-seletivo.css">
    <link rel="SHORTCUT ICON" href="https://www.spaceneedle.com.br/favicon.ico" type="image/x-icon" />
    <!-- <link href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap" rel="stylesheet"> -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400&display=swap" rel="stylesheet">
    <title>Quero Ser Space</title>
</head>   
<body >  
    <header class="cabecalho">
        <img class="logo" src="../assets/images/Space_Horizontal.png" >
    </header>

    <div id="load" class="loader">
    </div>

    <div id="main" class="none">
    <div class="centro">
        <section  class="container">
        <div class="card-centro-processo">
            <div class="title">
                <h1 >FEEDBACK</h1>
            </div>
            <div class="propriedades-process">
                <div id="properties">
                </div>
            </div>
            <div class="files-process" id="attachments">
            </div>
        </div>
        <div id="botoes">
            <input id="vagaBtn" class="btn btn-primary" type="submit" value="DETALHES DA VAGA" style="background: var(--primary-color-blue);">
            <input id="perfilBtn" class="btn btn-primary" type="submit" value="PERFIL" style="background: var(--primary-color-blue);">
        </div>
    </section>
    </div>
     <div class="fundo"></div>
</body>

<script>
    let id = window.location.search.substring(1);

    let endpoint = `https://i-wanna-be-space-storage.azurewebsites.net/download/$web/i-wanna-be-space/feedbacks/dados/${id}`;

    if (window.location.host != "" && window.location.host != "localhost" && location.protocol != 'https:')
    {
        location.href = location.href.replace("http:", "https:")
    }
    
    if(id){
        fetch(endpoint, {
            method:'GET',
        })
        .then(response => {
            // TODO: tratar erros response
        return response.json();
        })
        .then(item => {

            if(item != ''){
                // iterando as propriedades
                item.data.forEach(content => {  
                    let properties = document.getElementById("properties");

                    if(content['type'] == "text"){
                        let propertyDiv = document.createElement('div');
                        propertyDiv.classList.add('property');

                        let property = document.createElement('h3'); 
                        property.innerText = content['key'];

                        let propertyValue = document.createElement('p'); 
                        propertyValue.innerText = content['value'];

                        propertyDiv.appendChild(property);
                        propertyDiv.appendChild(propertyValue);
                        properties.appendChild(propertyDiv);

                    }else if(content['type'] == 'file'){

                        let attachments = document.getElementById('properties');
                        let div = document.createElement('div');

                        div.classList.add('sombra-anexo');
                        let divImg = document.createElement('div');
                        let img = document.createElement('img');
                        img.classList.add('anexo-img');

                        img.setAttribute('src', '../../assets/images/file.png');
                        divImg.appendChild(img);
                        div.appendChild(divImg);

                        let divName = document.createElement('div');
                        let p = document.createElement('p');
                        p.classList.add('file-description');
                        p.innerText = content['key'];
                        divName.appendChild(p);
                        div.appendChild(divName);

                        div.onclick = function() {

                            if(content['value'].startsWith('data:image')){
                                var image = new Image(),
                                containerWidth = null,
                                containerHeight = null;

                                image.onload=function(){
                                    containerWidth = image.width;
                                    containerHeight = image.height;
                                }
                                image.src = content['value'];

                                var w = window.open("");
                                w.document.write(image.outerHTML);
                            }else{
                                let pdfWindow = window.open("")
                                pdfWindow.document.write(
                                    "<iframe width='100%' style='margin: -8px;border: none;' height='100%' src='" +encodeURI(content['value']) + "'></iframe>"
                                )
                            }
                            
                        };

                        attachments.appendChild(div);

                    }else if(content['type'] == 'link'){
                
                        let propertyDiv = document.createElement('div');
                        propertyDiv.classList.add('property');

                        let property = document.createElement('h3'); 
                        property.innerText = content['key'];

                        let propertyValue = document.createElement('a');
                        propertyValue.setAttribute('href', content['value']);
                        propertyValue.setAttribute('target', '_blank');

                        propertyValue.innerText = 'Clique aqui para entender mais sobre o teste!';

                        propertyDiv.appendChild(property);
                        propertyDiv.appendChild(propertyValue);
                        properties.appendChild(propertyDiv);
                    }else if(content['type'] == 'candidato'){
                            document.getElementById("perfilBtn").onclick = function() {
                            url = window.location.href.split("/")[0];
                            window.location.href = url +'/candidatos?' + content['value'];
                        };
                    }else if(content['type'] == 'vaga'){
                        document.getElementById("vagaBtn").onclick = function() {
                            url = window.location.href.split("/")[0];
                            window.location.href = url +'/vaga?' + content['value'];
                        };
                    }
                });    
                loaded(); 
            }else{
                const url = window.location.href.split("/")[0];
                window.location.href = url +'/notFound.html';
            }
        })
        .catch(error =>{
            const url = window.location.href.split("/")[0];
            window.location.href = url +'/notFound.html';
        });
    }else{
        const url = window.location.href.split("/")[0];
        window.location.href = url +'/notFound.html';
    }
    
    function loaded() {
        let main = document.getElementById('main');
        let loader = document.getElementById('load');
        loader.remove('loader');
        main.classList.remove("none");
    }
</script>
</html>